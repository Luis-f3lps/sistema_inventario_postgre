<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <link rel="icon" href="images/icone3.png" type="image/png">
    <title>Inventário Produtos Químicos</title>
    <link rel="stylesheet" href="css/style5.css">
    <script src="https://kit.fontawesome.com/915b45d802.js" crossorigin="anonymous"></script>
</head>

<body>
    <!------------------Relatórios--------------->
    <div id="header">
        <nav>
            <ul id="sidemenu">
                <img src="images/logomenu.png" class="logo">
                </br>
                <li>
                    <span id="user-name" style="border-bottom: 1px solid; display: flex; align-items: center;">
                        <i class="fas fa-user"></i>
                        <span id="user-name-text"></span>
                    </span>
                </li>
                </br>

                <li class="Home" style="display: none;"><a href="/Home"><i class="fas fa-home"></i> Home</a></li>
                <li class="Horarios" style="display: none;"><a href="/Horario"><i class="fas fa-clock"></i> Horarios</a>
                </li>
                <li class="tecnico" style="display: none;"><a href="/Tela_Tecnico"><i class="fas fa-bell"></i>
                        Solicitações</a></li>
                <li class="professor" style="display: none;"><a href="/Tela_Professor"><i class="fas fa-bell"></i>
                        Solicitações Aula</a></li>

                <li class="submenu produto" style="display: none;">
                    <a href="#"><i class="fas fa-boxes"></i> Inventário <i class="fas fa-chevron-down"></i></a>
                    <ul class="submenu-items">
                        <li><a href="/MovimentacaoProduto"><i class="fas fa-exchange-alt"></i> Movimentação</a></li>
                        <li><a href="/Inventario"><i class="fas fa-boxes"></i> Inventário</a></li>
                        <li><a href="/Relatorio"><i class="fas fa-chart-line"></i> Relatórios</a></li>
                    </ul>
                </li>
                <!-- HTML para o menu de administração -->
                <li class="submenu admin-menu" style="display: none;">
                    <a href="#"><i class="fas fa-user-shield"></i> Administração <i class="fas fa-chevron-down"></i></a>
                    <ul class="submenu-items">
                        <li><a href="/Usuarios"><i class="fas fa-users"></i> Usuários</a></li>
                        <li><a href="/Produto"><i class="fas fa-tags"></i> Produtos</a></li>
                        <li><a href="/Laboratorio"><i class="fas fa-flask"></i> Laboratórios</a></li>
                    </ul>
                </li>
                </br>
                <li class="logout">
                    <a href="/logout" style="border-top: 1px solid;">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </a>
                </li>
                <i class="fa-solid fa-circle-xmark" onclick="clossmenu()"></i>
            </ul>
            <i class="fa-solid fa-bars" onclick="openmenu()" aria-hidden="true" style="margin: 30px; "></i>
        </nav>

        <div class="painel-principal-container">
            <div class="painel-grelha">
                <div class="cartao-painel cartao-aulas-solicitadas" style="display: none;">
                    <h2>Próximas Aulas Autorizadas</h2>
                    <ul id="lista-aulas-autorizadas" class="lista-painel">
                    </ul>
                </div>
                <div class="cartao-painel cartao-solicitacoes" style="display: none;">
                    <h2>Minhas Solicitações Recentes</h2>
                    <ul id="lista-solicitacoes" class="lista-painel">
                    </ul>
                </div>


                <div class="cartao-painel cartao-meus-laboratorios" style="display: none; width: 400px;">
                    <h2>Meus Laboratórios</h2>
                    <ul id="lista-meus-laboratorios" class="lista-painel">
                        <li>Quimica</li>
                    </ul>
                </div>
                <div class="cartao-painel cartao-aulas-tecnico" style="display: none;">
                    <h2>Aulas nos meus laboratorios</h2>
                    <ul id="lista-aulas-nos-meus-laboratorios" class="lista-painel">
                        <p style="text-align:center; color:#888; margin-top: 20px;">(Carregando...)</p>
                    </ul>
                </div>
            </div>
        </div>
        <script>

            // Função principal que inicia tudo quando a página carrega
            document.addEventListener('DOMContentLoaded', () => {
                ativarFuncionalidadeMenu();
                carregarDadosDaPagina();
            });

            /**
             * Adiciona os eventos de clique aos botões do menu.
             */
            function ativarFuncionalidadeMenu() {
                const sideMenu = document.getElementById("sidemenu");
                const openMenuBtn = document.querySelector(".fa-bars");
                const closeMenuBtn = document.querySelector(".fa-circle-xmark");

                if (openMenuBtn) openMenuBtn.addEventListener('click', () => sideMenu.style.left = "0px");
                if (closeMenuBtn) closeMenuBtn.addEventListener('click', () => sideMenu.style.left = "-800px");

                // Lógica segura para os submenus 
                document.querySelectorAll('.submenu > a').forEach(menu => {
                    menu.addEventListener('click', function (e) {
                        e.preventDefault();
                        const submenuItems = this.nextElementSibling;
                        const icon = this.querySelector('.fas.fa-chevron-down');

                        // Verifica se o submenu existe antes de tentar manipulá-lo
                        if (submenuItems) {
                            submenuItems.classList.toggle('open');
                        }
                        // Verifica se o ícone existe antes de tentar girá-lo
                        if (icon) {
                            icon.classList.toggle('rotate');
                        }
                    });
                });
            }

            /**
             * Função que busca os dados do utilizador e depois os dados do painel.
             */
            async function carregarDadosDaPagina() {
                try {
                    const response = await fetch('/api/usuario-logado');
                    if (!response.ok) {
                        window.location.href = '/login.html';
                        return;
                    }
                    const loggedInUser = await response.json();

                    const userNameElement = document.getElementById('user-name-text');
                    if (userNameElement) {
                        userNameElement.textContent = loggedInUser.nome_usuario || loggedInUser.nome;
                    }

                    // Lógica unificada para exibição de menus
                    const userType = loggedInUser.tipo_usuario ? loggedInUser.tipo_usuario.trim().toLowerCase() : '';

                    switch (userType) {
                        case 'admin':
                            if (window.location.pathname !== '/Inventario' && window.location.pathname !== '/Inventario.html') {
                                window.location.href = '/Inventario';
                            }

                            document.querySelector('.admin-menu').style.display = 'block';
                            document.querySelector('#sidemenu > li.submenu.produto').style.display = 'block';

                            break;
                        case 'tecnico':
                            document.querySelector('.tecnico').style.display = 'block';
                            document.querySelector('.Home').style.display = 'block';
                            document.querySelector('#sidemenu > li.submenu.produto').style.display = 'block';
                            document.querySelector('.cartao-aulas-tecnico').style.display = 'block';
                            document.querySelector('.cartao-meus-laboratorios').style.display = 'block';
                            break;
                        case 'professor':
                            document.querySelector('.Home').style.display = 'block';
                            document.querySelector('.professor').style.display = 'block';
                            document.querySelector('.Horarios').style.display = 'block';
                            document.querySelector('.cartao-aulas-solicitadas').style.display = 'block';
                            document.querySelector('.cartao-solicitacoes').style.display = 'block';
                            break;
                    }

                    // Agora, busca os dados específicos do painel
                    carregarDadosDoPainel();

                } catch (error) {
                    console.error('Erro ao carregar dados da página:', error);
                }
            }

            /**
             * Busca os dados para os cartões do painel.
             */
            function carregarDadosDoPainel() {
                Promise.all([
                    fetch('/api/dashboard/solicitacoes-recentes').then(res => res.json()),
                    fetch('/api/dashboard/aulas-autorizadas').then(res => res.json()),
                    fetch('/api/dashboard/meus-laboratorios').then(res => res.json()),
                    fetch('/api/aulas-meus-laboratorios').then(res => res.json())

                ]).then(([solicitacoes, aulasAutorizadas, meusLaboratorios, aulasNosMeusLabs]) => {

                    if (typeof renderizarSolicitacoes === 'function') renderizarSolicitacoes(solicitacoes);
                    if (typeof renderizarAulasAutorizadas === 'function') renderizarAulasAutorizadas(aulasAutorizadas);
                    if (typeof renderizarMeusLaboratorios === 'function') renderizarMeusLaboratorios(meusLaboratorios);

                    if (typeof renderizarAulasNosMeusLaboratorios === 'function') {
                        renderizarAulasNosMeusLaboratorios(aulasNosMeusLabs);
                    }

                }).catch(error => console.error('Erro ao carregar dados dos painéis:', error));
            }
            function renderizarSolicitacoes(solicitacoes) {
                const lista = document.getElementById('lista-solicitacoes');
                if (!lista) return;
                if (solicitacoes.length === 0) {
                    lista.innerHTML = '<li>Nenhuma solicitação recente.</li>'; return;
                }
                lista.innerHTML = solicitacoes.map(s => `
            <li>
                <span>${s.nome_laboratorio} (${new Date(s.data).toLocaleDateString('pt-BR', { timeZone: 'UTC' })} | ${s.hora_inicio.slice(0, 5)} - ${s.hora_fim.slice(0, 5)})</span>
                <span class="etiqueta-status status-${s.status}">${s.status}</span>
            </li>
        `).join('');
            }

            function renderizarAulasAutorizadas(aulas) {
                const lista = document.getElementById('lista-aulas-autorizadas');
                if (!lista) return;
                if (aulas.length === 0) {
                    lista.innerHTML = '<li>Nenhuma aula autorizada futura.</li>'; return;
                }
                lista.innerHTML = aulas.map(a => `
            <li>
                <span>${a.nome_laboratorio}</span>
                <span>${new Date(a.data).toLocaleDateString('pt-BR', { timeZone: 'UTC' })} | ${a.hora_inicio.slice(0, 5)} - ${a.hora_fim.slice(0, 5)}</span>
            </li>
        `).join('');
            }

            function renderizarMeusLaboratorios(laboratorios) {
                const lista = document.getElementById('lista-meus-laboratorios');
                if (!lista) return;
                if (laboratorios.length === 0) {
                    lista.innerHTML = '<li>Você não é responsável por nenhum laboratório.</li>'; return;
                }
                lista.innerHTML = laboratorios.map(l => `<li>${l.nome_laboratorio}</li>`).join('');
            }

            function renderizarAulasNosMeusLaboratorios(aulas) {
                const lista = document.getElementById('lista-aulas-nos-meus-laboratorios');
                if (!lista) return;

                lista.innerHTML = '';

                if (!aulas || aulas.length === 0) {
                    lista.innerHTML = '<li>Nenhuma aula futura agendada nos seus laboratórios.</li>';
                    return;
                }

                lista.innerHTML = aulas.map(aula => {
                    const dataFormatada = new Date(aula.data).toLocaleDateString('pt-BR', { timeZone: 'UTC' });
                    const horaInicio = aula.hora_inicio.slice(0, 5);
                    const horaFim = aula.hora_fim.slice(0, 5);

                    const precisaTecnicoTexto = aula.precisa_tecnico ? 'Sim' : 'Não';

                    return `
            <li class="item-painel-detalhado">
                <strong >${aula.nome_laboratorio}</strong>
                <span class="detalhe-item-painel" >Professor(a): ${aula.nome_professor}</span>
                <span class="detalhe-item-painel">${dataFormatada} | ${horaInicio} - ${horaFim}</span>
                <span class="detalhe-item-painel">Apoio Técnico: <strong>${precisaTecnicoTexto}</strong></span>
            </li>
        `;
                }).join('');
            }

        </script>
</body>

</html>