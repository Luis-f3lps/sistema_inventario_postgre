<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <link rel="icon" href="images/icone3.png" type="image/png">
    <title>Inventário Produtos Químicos</title>
    <link rel="stylesheet" href="css/style5.css">
    <script src="https://kit.fontawesome.com/915b45d802.js" crossorigin="anonymous"></script>
</head>

<body>

    <header id="menu-container"></header>

    <div class="agendamento-container">
        <h1>Agendar Aula — Escolha data e horário</h1>

        <div class="seletor-fila">
            <label for="lab">Laboratório</label>
                                    <select id="laboratorios-select2" name="laboratorio">
                                        <option value="">Todos os Laboratórios</option>
                                        <!-- Opções serão preenchidas dinamicamente -->
                                    </select>

            <label for="date">Data</label>
            <input id="date" type="date" />
        </div>

        <div>
            <strong>Horários disponíveis:</strong>
            <div id="slots" class="grade-horarios"></div>
            <div class="texto-ajuda">Aulas de 1 hora. Manhã: 07h–11h. Tarde/Noite: 13h–22h.</div>
        </div>

        <div class="opcao-tecnico-fila">
            <span>Precisa de acompanhamento do técnico?</span>
            <div class="radio-options">
                <input type="radio" id="tecnicoSim" name="precisaTecnico" value="true">
                <label for="tecnicoSim">Sim</label>

                <input type="radio" id="tecnicoNao" name="precisaTecnico" value="false" checked>
                <label for="tecnicoNao">Não</label>
            </div>
        </div>

        <div id="msg" class="mensagem-status"></div>
        <button id="submitBtn" class="btn-principal" disabled>Solicitar Aula</button>
    </div>

    <script>
        // ===================================================================
        // PONTO DE ENTRADA PRINCIPAL DA PÁGINA
        // ===================================================================
        document.addEventListener('DOMContentLoaded', () => {
            inicializarPaginaDeAgendamento();
            loadLaboratorios();

        });

        // ===================================================================
        // VARIÁVEIS GLOBAIS DA PÁGINA
        // ===================================================================
        let loggedInUser = null;
        const slotsEl = document.getElementById('slots');
        const dateEl = document.getElementById('date');
        const labEl = document.getElementById('lab');
        const submitBtn = document.getElementById('submitBtn');
        const msgEl = document.getElementById('msg');
        let occupiedSlots = [];
        let selectedSlot = null;

        // ===================================================================
        // LÓGICA DE INICIALIZAÇÃO E FLUXO
        // ===================================================================

        /**
         * Orquestra o carregamento da página na ordem correta.
         */
        async function inicializarPaginaDeAgendamento() {
            // Ativa os botões do menu lateral primeiro
            ativarFuncionalidadeMenu();

            // Define a data de hoje no calendário
            dateEl.value = new Date().toISOString().slice(0, 10);

            // Adiciona os "ouvintes" de eventos para interações do usuário
            dateEl.addEventListener('change', loadAvailability);
            labEl.addEventListener('change', loadAvailability);
            submitBtn.addEventListener('click', submeterAgendamento);

            // Carrega os dados do usuário. Se o login for válido, continua.
            loggedInUser = await loadLoggedInUser();
            if (loggedInUser) {
                // **AQUI ESTÁ A CORREÇÃO PRINCIPAL**
                // Carrega os horários para a data de hoje AUTOMATICAMENTE
                await loadAvailability();
            }
        }
function loadLaboratorios() {
    fetch('/api/lab')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('laboratorios-select2');
            select.innerHTML = '<option value="">Todos os Laboratórios</option>'; // Adiciona a opção "Todos os Laboratórios"
            data.forEach(laboratorio => {
                const option = document.createElement('option');
                option.value = laboratorio.id_laboratorio;
                option.textContent = laboratorio.nome_laboratorio;
                select.appendChild(option);
            });
        })
        .catch(error => console.error('Erro ao carregar laboratórios:', error));
}
        /**
         * Busca os dados do usuário logado. Se não estiver logado, redireciona.
         */
        async function loadLoggedInUser() {
            try {
                const response = await fetch('/api/usuario-logado');
                if (!response.ok) {
                    window.location.href = 'login.html';
                    return null;
                }
                const userData = await response.json();

                // Preenche o nome e ajusta os menus visíveis
                preencherDadosDoMenu(userData);

                return userData; // Retorna os dados para uso em outras funções
            } catch (error) {
                console.error('Erro de conexão ao verificar usuário:', error);
                window.location.href = 'login.html';
                return null;
            }
        }

        // ===================================================================
        // LÓGICA PRINCIPAL DE AGENDAMENTO
        // ===================================================================

        /**
         * Busca na API os horários já ocupados para a data e lab selecionados.
         */
        /**
         * Busca na API os horários já ocupados para a data e lab selecionados.
         */
        async function loadAvailability() {
            // Garante que os elementos essenciais existem
            if (!dateEl || !labEl || !slotsEl || !msgEl || !submitBtn) return;

            // --- CORREÇÃO PRINCIPAL: Limpa a mensagem logo no início ---
            // Desta forma, sempre que a função é chamada, a tela fica limpa.
            msgEl.style.display = 'none';

            // Se a data não estiver preenchida, não faz mais nada
            if (!dateEl.value) return;
            msgEl.className = 'mensagem-status';

            // Agora, faz a verificação de datas passadas
            const hojeStr = new Date().toISOString().slice(0, 10);
            if (dateEl.value < hojeStr) {
                slotsEl.innerHTML = ''; // Limpa a área de horários
                msgEl.textContent = 'Não é possível agendar em datas passadas.';
                msgEl.className = 'mensagem-status erro';
                msgEl.style.display = 'block'; // Mostra a mensagem de erro específica
                submitBtn.disabled = true;
                return; // Para a execução
            }

            // Reseta o estado da interface para a nova busca
            slotsEl.innerHTML = '<p>Carregando horários...</p>';
            submitBtn.disabled = true;
            selectedSlot = null;

            // Busca os dados na API
            try {
                const res = await fetch(`/api/availability?date=${dateEl.value}&labId=${labEl.value}`);
                if (!res.ok) throw new Error('Falha ao buscar horários.');

                const data = await res.json();
                occupiedSlots = data.occupied || [];

                renderSlots(); // Chama a função para desenhar os botões

            } catch (error) {
                console.error('Erro ao carregar disponibilidade:', error);
                slotsEl.innerHTML = '<p style="color: red;">Erro ao carregar horários. Tente novamente.</p>';
            }
        }

        /**
         * Desenha os botões de horário (disponíveis e ocupados) na tela.
         */
        function renderSlots() {
            const allSlots = generateAllSlots();
            slotsEl.innerHTML = '';

            allSlots.forEach(hour => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'bloco-horario';
                btn.textContent = `${hour} — ${formatEnd(hour)}`;
                btn.dataset.hour = hour;

                if (occupiedSlots.includes(hour)) {
                    btn.classList.add('occupied');
                    btn.disabled = true;
                } else {
                    btn.addEventListener('click', () => {
                        selectedSlot = (selectedSlot === btn.dataset.hour && selectedSlot !== null) ? null : btn.dataset.hour;
                        updateSelectionUI();
                    });
                }
                slotsEl.appendChild(btn);
            });
            updateSelectionUI();
        }

        /**
         * Atualiza a interface para destacar o horário selecionado.
         */
        function updateSelectionUI() {
            document.querySelectorAll('.bloco-horario').forEach(el => {
                el.classList.remove('selected');
                if (!el.disabled && el.dataset.hour === selectedSlot) {
                    el.classList.add('selected');
                }
            });
            submitBtn.disabled = !selectedSlot;
        }

        /**
         * Envia o novo agendamento para a API.
         */
        async function submeterAgendamento() {
            if (!selectedSlot || !loggedInUser) return;

            const payload = {
                labId: labEl.value,
                date: dateEl.value,
                hour: selectedSlot,
                precisa_tecnico: document.querySelector('input[name="precisaTecnico"]:checked').value === 'true'
            };

            try {
                const res = await fetch('/api/schedule', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await res.json();
                if (!res.ok) throw new Error(result.error || 'Ocorreu um erro');

                // Exibe mensagem de sucesso
                msgEl.textContent = result.message;
                msgEl.className = 'mensagem-status sucesso';
                msgEl.style.display = 'block';

                await loadAvailability(); // Recarrega os horários
            } catch (err) {
                msgEl.textContent = 'Erro ao enviar: ' + err.message;
                msgEl.className = 'mensagem-status erro';
                msgEl.style.display = 'block';
            }
        }


        function generateAllSlots() {
            const arr = [];
            for (let h = 7; h < 11; h++) arr.push(formatHour(h));
            for (let h = 13; h < 22; h++) arr.push(formatHour(h));
            return arr;
        }

        function formatHour(h) { return (h < 10 ? '0' : '') + h + ':00'; }

        function formatEnd(start) {
            const endH = parseInt(start.split(':')[0]) + 1;
            return formatHour(endH);
        }
    </script>
    <script src="js/menu.js" defer></script>

</body>

</html>