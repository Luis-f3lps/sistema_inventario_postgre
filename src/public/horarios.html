<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <link rel="icon" href="images/icone3.png" type="image/png">
    <title>Inventário Produtos Químicos</title>
    <link rel="stylesheet" href="css/style5.css">
    <script src="https://kit.fontawesome.com/915b45d802.js" crossorigin="anonymous"></script>
</head>
<body>
<!------------------Relatórios--------------->
<div id="header">
        <nav>
            <ul id="sidemenu">
                <img src="images/logomenu.png" class="logo">
                </br>
                <li>
                    <span id="user-name" style="border-bottom: 1px solid; display: flex; align-items: center;">
                        <i class="fas fa-user"></i>
                        <span id="user-name-text"></span>
                    </span>
                </li>
                </br>

                <li><a href="/Horario"><i class="fas fa-clock"></i> Horarios</a></li>
                <li><a href="/Tela_Tecnico"><i class="fas fa-bell"></i> Solicitações</a></li>
                <li><a href="/Tela_Professor"><i class="fas fa-bell"></i> Solicitações Aula</a></li>

                <li class="submenu produto">
                    <a href="#"><i class="fas fa-boxes"></i> Inventário <i class="fas fa-chevron-down"></i></a>
                    <ul class="submenu-items">
                        <li><a href="/MovimentacaoProduto"><i class="fas fa-exchange-alt"></i> Movimentação</a></li>
                        <li><a href="/Inventario"><i class="fas fa-boxes"></i> Inventário</a></li>
                        <li><a href="/Relatorio"><i class="fas fa-chart-line"></i> Relatórios</a></li>
                                    </ul>
                </li>
                <!-- HTML para o menu de administração -->
                <li class="submenu admin-menu" style="display: none;">
                    <a href="#"><i class="fas fa-user-shield"></i> Administração <i class="fas fa-chevron-down"></i></a>
                    <ul class="submenu-items">
                        <li><a href="/Usuarios"><i class="fas fa-users"></i> Usuários</a></li>
                        <li><a href="/Produto"><i class="fas fa-tags"></i> Produtos</a></li>
                        <li><a href="/Laboratorio"><i class="fas fa-flask"></i> Laboratórios</a></li>
                    </ul>
                </li>
                </br>
                <li class="logout">
                    <a href="index.html" style="border-top: 1px solid;">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </a>
                    <i class="fa-solid fa-circle-xmark" onclick="clossmenu()"></i>
                </ul>
                <i class="fa-solid fa-bars" onclick="openmenu()" aria-hidden="true" style="margin: 30px; "></i>
            </nav>
    <div class="agendamento-container">
        <h1>Agendar Aula — Escolha data e horário</h1>

        <div class="seletor-fila">
            <label for="lab">Laboratório</label>
            <select id="lab">
                <option value="1">Física (Lab 1)</option>
                <option value="4">Química (Lab 4)</option>
            </select>

            <label for="date">Data</label>
            <input id="date" type="date" />
        </div>

        <div>
            <strong>Horários disponíveis:</strong>
            <div id="slots" class="grade-horarios"></div>
            <div class="texto-ajuda">Aulas de 1 hora. Manhã: 07h–11h. Tarde/Noite: 13h–22h.</div>
        </div>

        <div class="opcao-tecnico-fila">
            <span>Precisa de acompanhamento do técnico?</span>
            <div class="radio-options">
                <input type="radio" id="tecnicoSim" name="precisaTecnico" value="true">
                <label for="tecnicoSim">Sim</label>
                
                <input type="radio" id="tecnicoNao" name="precisaTecnico" value="false" checked>
                <label for="tecnicoNao">Não</label>
            </div>
        </div>

        <div id="msg" class="mensagem-status"></div>
        <button id="submitBtn" class="btn-principal" disabled>Solicitar Aula</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const menuContainer = document.getElementById('menu-container');
            if (menuContainer) {
                fetch('menu.html')
                    .then(response => response.text())
                    .then(data => {
                        menuContainer.innerHTML = data;
                        // O código para fazer os botões do menu funcionar vai aqui...
                    })
                    .catch(error => console.error('Erro ao carregar o menu:', error));
            }
        });
        document.querySelectorAll('.submenu > a').forEach(menu => {
    menu.addEventListener('click', function(e) {
        e.preventDefault();
        const submenuItems = this.nextElementSibling;
        submenuItems.classList.toggle('open');
        this.querySelector('.fas.fa-chevron-down').classList.toggle('rotate');
    });
});

    </script>

<script>
 let loggedInUser = null;

    // --- FUNÇÕES DE AUTENTICAÇÃO E DADOS ---
    async function loadLoggedInUser() {
        try {
            const response = await fetch('/api/usuario-logado');
            if (!response.ok) {
                window.location.href = '/login.html';
                return;
            }
            loggedInUser = await response.json();
            
            const userNameElement = document.getElementById('user-name-text');
            if(userNameElement) {
                userNameElement.textContent = loggedInUser.nome_usuario || loggedInUser.nome;
            }
            
            await loadAvailability();
        } catch (error) {
            console.error('Erro ao carregar usuário logado:', error);
        }
    }

    // --- ELEMENTOS E CONSTANTES ---
    const slotsEl = document.getElementById('slots');
    const dateEl = document.getElementById('date');
    const labEl = document.getElementById('lab');
    const submitBtn = document.getElementById('submitBtn');
    const msgEl = document.getElementById('msg');
    
    // ... (outras constantes como morningStart, etc.)

    // --- FUNÇÕES DE AGENDAMENTO ---

    // >>> A LÓGICA ATUALIZADA ESTÁ AQUI <<<
    async function loadAvailability() {
        const dataSelecionadaStr = dateEl.value;
        const labId = labEl.value;

        // Limpa a mensagem anterior
        msgEl.style.display = 'none';
        msgEl.className = 'mensagem-status'; // Reseta as classes

        // --- VALIDAÇÃO DA DATA ---
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0); // Zera a hora para comparar apenas o dia

        // Converte a string da data do input para um objeto Date
        const [ano, mes, dia] = dataSelecionadaStr.split('-').map(Number);
        const dataSelecionada = new Date(ano, mes - 1, dia);

        if (dataSelecionada < hoje) {
            slotsEl.innerHTML = ''; // Limpa os horários
            submitBtn.disabled = true; // Desativa o botão de submeter
            
            // Mostra a mensagem de erro "bonita"
            msgEl.textContent = 'Não é possível agendar aulas para uma data que já passou.';
            msgEl.classList.add('erro');
            return; // Interrompe a execução da função
        }
        // --- FIM DA VALIDAÇÃO ---

        selectedSlot = null;
        submitBtn.disabled = true;

        try {
            occupiedSlots = await fetchOccupiedSlotsFromAPI(dataSelecionadaStr, labId);
            renderSlots();
        } catch (error) {
            console.error('Erro ao carregar disponibilidade:', error);
            msgEl.textContent = 'Erro ao carregar horários. Tente novamente.';
            msgEl.classList.add('erro');
        }
    }
    
    // ... (O resto das suas funções: generateAllSlots, formatHour, renderSlots, etc. continuam iguais)
    
    function generateAllSlots() { /* ...código igual... */ }
    function formatHour(h) { /* ...código igual... */ }
    function formatEnd(start) { /* ...código igual... */ }
    function renderSlots() { /* ...código igual... */ }
    function updateSelectionUI() { /* ...código igual... */ }
    async function fetchOccupiedSlotsFromAPI(date, labId) { /* ...código igual... */ }

    // --- EVENT LISTENERS E INICIALIZAÇÃO ---
    dateEl.addEventListener('change', loadAvailability);
    labEl.addEventListener('change', loadAvailability);
    
    submitBtn.addEventListener('click', async () => { /* ...código igual... */ });

    document.addEventListener('DOMContentLoaded', () => {
        const today = new Date().toISOString().slice(0, 10);
        dateEl.value = today;
        loadLoggedInUser();
    });
</script>
  </body>
</html>