<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <link rel="icon" href="images/icone3.png" type="image/png">
    <title>Inventário Produtos Químicos</title>
    <link rel="stylesheet" href="css/style5.css">
    <script src="https://kit.fontawesome.com/915b45d802.js" crossorigin="anonymous"></script>
</head>
<body>
<!------------------Relatórios--------------->
<div id="header">
        <nav>
            <ul id="sidemenu">
                <img src="images/logomenu.png" class="logo">
                </br>
                <li>
                    <span id="user-name" style="border-bottom: 1px solid; display: flex; align-items: center;">
                        <i class="fas fa-user"></i>
                        <span id="user-name-text"></span>
                    </span>
                </li>
                </br>
                <li><a href="/MovimentacaoProduto"><i class="fas fa-exchange-alt"></i> Movimentação</a></li>
                <li><a href="/Inventario"><i class="fas fa-boxes"></i> Inventário</a></li>
                <li><a href="/Relatorio"><i class="fas fa-chart-line"></i> Relatórios</a></li>
                <li><a href="/Horario"><i class="fas fa-chart-line"></i> Horario</a></li>
                <li><a href="/Tela_Tecnico"><i class="fas fa-chart-line"></i> Tela Tecnico</a></li>

                <!-- HTML para o menu de administração -->
                <li class="submenu admin-menu" style="display: none;">
                    <a href="#"><i class="fas fa-user-shield"></i> Administração <i class="fas fa-chevron-down"></i></a>
                    <ul class="submenu-items">
                        <li><a href="/Usuarios"><i class="fas fa-users"></i> Usuários</a></li>
                        <li><a href="/Produto"><i class="fas fa-tags"></i> Produtos</a></li>
                        <li><a href="/Laboratorio"><i class="fas fa-flask"></i> Laboratórios</a></li>
                    </ul>
                </li>
                </br>
                <li class="logout">
                    <a href="index.html" style="border-top: 1px solid;">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </a>
                    <i class="fa-solid fa-circle-xmark" onclick="clossmenu()"></i>
                </ul>
                <i class="fa-solid fa-bars" onclick="openmenu()" aria-hidden="true" style="margin: 30px; "></i>
            </nav>
        <div class="container">
            <div class="row">            

            <h1>Agendar Aula — Escolha data e horário</h1>

            <div class="row">
                <label for="lab">Laboratório</label>
                <select id="lab">
                <!-- Substitua/Popule dinamicamente com seus labs -->
                <option value="1">Física (Lab 1)</option>
                <option value="4">Química (Lab 4)</option>
                </select>

                <label for="date">Data</label>
                <input id="date" type="date" />
            </div>

            <div>
                <strong>Horários disponíveis:</strong>
                <div id="slots" class="slots" aria-live="polite"></div>
                <div class="help">Aulas de 1 hora. Manhã: 07h–11h (7→10). Tarde/Noite: 13h–22h (13→21).</div>
            </div>
<div class="row-radio">
    <span>Precisa de acompanhamento do técnico?</span>
    <div class="radio-options">
        <input type="radio" id="tecnicoSim" name="precisaTecnico" value="true">
        <label for="tecnicoSim">Sim</label>
        
        <input type="radio" id="tecnicoNao" name="precisaTecnico" value="false" checked>
        <label for="tecnicoNao">Não</label>
    </div>
</div>

        <div id="msg" class="msg"></div>
            <button id="submitBtn" class="primary" disabled>Solicitar Aula</button>
            <div id="msg" class="msg"></div>
        </div>
</div>
</div>

<script>
    // Variável global para guardar os dados do usuário logado
    let loggedInUser = null;

    // --- FUNÇÕES DE AUTENTICAÇÃO E DADOS ---
    async function loadLoggedInUser() {
        try {
            const response = await fetch('/api/usuario-logado');
            if (!response.ok) {
                // Se não estiver logado, redireciona para a página de login
                window.location.href = '/login.html'; // Crie uma página de login
                return;
            }
            const data = await response.json();
            loggedInUser = data; // Guarda os dados do usuário

            const userNameElement = document.getElementById('user-name-text');
            userNameElement.textContent = data.nome;
            if (data.tipo_usuario === 'admin') {
                document.querySelector('.admin-menu').style.display = 'block';
            }
        } catch (error) {
            console.error('Erro ao carregar usuário logado:', error);
        }
    }

    // --- FUNÇÕES DE AGENDAMENTO ---

    const slotsEl = document.getElementById('slots');
    const dateEl = document.getElementById('date');
    const labEl = document.getElementById('lab');
    const submitBtn = document.getElementById('submitBtn');
    const msgEl = document.getElementById('msg');
    const precisaTecnicoEl = document.getElementById('precisaTecnico');

    const morningStart = 7, morningEndExclusive = 11;
    const afternoonStart = 13, afternoonEndExclusive = 22;

    let occupiedSlots = [];
    let selectedSlot = null;

    // ✅ INÍCIO DO CÓDIGO QUE FALTAVA

    // Gera o array completo de todos os horários possíveis
    function generateAllSlots() {
        const arr = [];
        for (let h = morningStart; h < morningEndExclusive; h++) arr.push(formatHour(h));
        for (let h = afternoonStart; h < afternoonEndExclusive; h++) arr.push(formatHour(h));
        return arr;
    }

    // Formata uma hora para o formato "HH:00"
    function formatHour(h) {
        return (h < 10 ? '0' + h : '' + h) + ':00';
    }
    
    // Calcula a hora de término (ex: "07:00" -> "08:00")
    function formatEnd(start) {
        const [hh, mm] = start.split(':').map(Number);
        const endH = hh + 1;
        return (endH < 10 ? '0' + endH : '' + endH) + ':00';
    }

    // Renderiza os botões na tela, marcando os ocupados
    function renderSlots() {
        const all = generateAllSlots();
        slotsEl.innerHTML = '';
        all.forEach(hour => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'slot';
            btn.textContent = `${hour} — ${formatEnd(hour)}`;
            btn.dataset.hour = hour;

            if (occupiedSlots.includes(hour)) {
                btn.classList.add('occupied');
                btn.setAttribute('aria-disabled', 'true');
            } else {
                btn.addEventListener('click', () => {
                    if (selectedSlot === hour) {
                        selectedSlot = null;
                    } else {
                        selectedSlot = hour;
                    }
                    updateSelectionUI();
                });
            }
            slotsEl.appendChild(btn);
        });
        updateSelectionUI();
    }
    
    // Atualiza a interface para mostrar qual botão está selecionado
    function updateSelectionUI() {
        document.querySelectorAll('.slot').forEach(el => {
            el.classList.remove('selected');
            if (!el.classList.contains('occupied') && el.dataset.hour === selectedSlot) {
                el.classList.add('selected');
            }
        });
        submitBtn.disabled = !selectedSlot;
    }
    // ✅ FIM DO CÓDIGO QUE FALTAVA


    // --- CONEXÃO COM A API REAL ---
    async function fetchOccupiedSlotsFromAPI(date, labId) {
        const res = await fetch(`/api/availability?date=${encodeURIComponent(date)}&labId=${encodeURIComponent(labId)}`);
        if (!res.ok) throw new Error('Falha ao consultar disponibilidade');
        const data = await res.json();
        return data.occupied || [];
    }

    async function loadAvailability() {
        const date = dateEl.value;
        const labId = labEl.value;
        selectedSlot = null;
        submitBtn.disabled = true;
        msgEl.style.display = 'none';

        try {
            occupiedSlots = await fetchOccupiedSlotsFromAPI(date, labId);
            renderSlots();
        } catch (error) {
            console.error('Erro ao carregar disponibilidade:', error);
            msgEl.textContent = 'Erro ao carregar horários. Tente novamente.';
            msgEl.style.color = 'red';
            msgEl.style.display = 'block';
        }
    }

    // Quando a data ou lab mudar
    dateEl.addEventListener('change', loadAvailability);
    labEl.addEventListener('change', loadAvailability);

    // SUBMIT USANDO A API REAL E O USUÁRIO LOGADO
    submitBtn.addEventListener('click', async () => {
        if (!selectedSlot || !loggedInUser) return;

        const payload = {
            labId: labEl.value,
            date: dateEl.value,
            hour: selectedSlot,
    precisa_tecnico: document.querySelector('input[name="precisaTecnico"]:checked').value === 'true'
        };

        try {
            const res = await fetch('/api/schedule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await res.json();
            if (!res.ok) {
                throw new Error(result.error || 'Ocorreu um erro');
            }

            msgEl.textContent = result.message;
            msgEl.style.color = 'green';
            msgEl.style.display = 'block';
            
            loadAvailability();

        } catch (err) {
            msgEl.textContent = 'Erro ao enviar: ' + err.message;
            msgEl.style.color = 'red';
            msgEl.style.display = 'block';
        }
    });

    // --- INICIALIZAÇÃO DA PÁGINA ---
    document.addEventListener('DOMContentLoaded', () => {
        loadLoggedInUser(); // Primeiro, verifica quem está logado
        
        const today = new Date().toISOString().slice(0, 10);
        dateEl.value = today;
        
        loadAvailability(); // Depois, carrega os horários
    });

</script>
  </body>
</html>