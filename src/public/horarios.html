<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <link rel="icon" href="images/icone3.png" type="image/png">
    <title>Inventário Produtos Químicos</title>
    <link rel="stylesheet" href="css/style5.css">
    <script src="https://kit.fontawesome.com/915b45d802.js" crossorigin="anonymous"></script>
</head>

<body>
    <!------------------Relatórios--------------->
    <div id="header">
        <nav>
            <ul id="sidemenu">
                <img src="images/logomenu.png" class="logo">
                </br>
                <li>
                    <span id="user-name" style="border-bottom: 1px solid; display: flex; align-items: center;">
                        <i class="fas fa-user"></i>
                        <span id="user-name-text"></span>
                    </span>
                </li>
                </br>

                <li><a href="/Home"><i class="fas fa-home"></i> Home</a></li>
                <li class="Horarios" style="display: none;"><a href="/Horario"><i class="fas fa-clock"></i> Horarios</a>
                </li>
                <li class="tecnico" style="display: none;"><a href="/Tela_Tecnico"><i class="fas fa-bell"></i>
                        Solicitações</a></li>
                <li class="professor" style="display: none;"><a href="/Tela_Professor"><i class="fas fa-bell"></i>
                        Solicitações Aula</a></li>

                <li class="submenu produto" style="display: none;">
                    <a href="#"><i class="fas fa-boxes"></i> Inventário <i class="fas fa-chevron-down"></i></a>
                    <ul class="submenu-items">
                        <li><a href="/MovimentacaoProduto"><i class="fas fa-exchange-alt"></i> Movimentação</a></li>
                        <li><a href="/Inventario"><i class="fas fa-boxes"></i> Inventário</a></li>
                        <li><a href="/Relatorio"><i class="fas fa-chart-line"></i> Relatórios</a></li>
                    </ul>
                </li>
                <!-- HTML para o menu de administração -->
                <li class="submenu admin-menu" style="display: none;">
                    <a href="#"><i class="fas fa-user-shield"></i> Administração <i class="fas fa-chevron-down"></i></a>
                    <ul class="submenu-items">
                        <li><a href="/Usuarios"><i class="fas fa-users"></i> Usuários</a></li>
                        <li><a href="/Produto"><i class="fas fa-tags"></i> Produtos</a></li>
                        <li><a href="/Laboratorio"><i class="fas fa-flask"></i> Laboratórios</a></li>
                    </ul>
                </li>
                </br>
                <li class="logout">
                    <a href="/logout" style="border-top: 1px solid;">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </a>
                </li>
                <i class="fa-solid fa-circle-xmark" onclick="clossmenu()"></i>
            </ul>
            <i class="fa-solid fa-bars" onclick="openmenu()" aria-hidden="true" style="margin: 30px; "></i>
        </nav>
        <div class="agendamento-container">
            <h1>Agendar Aula — Escolha data e horário</h1>

            <div class="seletor-fila">
                <label for="lab">Laboratório</label>
                <select id="lab">
                    <option value="1">Física (Lab 1)</option>
                    <option value="4">Química (Lab 4)</option>
                </select>

                <label for="date">Data</label>
                <input id="date" type="date" />
            </div>

            <div>
                <strong>Horários disponíveis:</strong>
                <div id="slots" class="grade-horarios"></div>
                <div class="texto-ajuda">Aulas de 1 hora. Manhã: 07h–11h. Tarde/Noite: 13h–22h.</div>
            </div>

            <div class="opcao-tecnico-fila">
                <span>Precisa de acompanhamento do técnico?</span>
                <div class="radio-options">
                    <input type="radio" id="tecnicoSim" name="precisaTecnico" value="true">
                    <label for="tecnicoSim">Sim</label>

                    <input type="radio" id="tecnicoNao" name="precisaTecnico" value="false" checked>
                    <label for="tecnicoNao">Não</label>
                </div>
            </div>

            <div id="msg" class="mensagem-status"></div>
            <button id="submitBtn" class="btn-principal" disabled>Solicitar Aula</button>
        </div>

        <script>
            // ÚNICO PONTO DE INÍCIO QUANDO A PÁGINA CARREGA
            document.addEventListener('DOMContentLoaded', () => {
                // 1. Ativa a funcionalidade do menu, pois ele já está no HTML
                ativarFuncionalidadeMenu();

                // 2. Define a data de hoje no calendário (se o elemento existir)
                const dateEl = document.getElementById('date');
                if (dateEl) {
                    const today = new Date().toISOString().slice(0, 10);
                    dateEl.value = today;
                }

                // 3. Inicia o processo de carregar os dados do utilizador e da página
                loadLoggedInUser();
                inicializarPaginaDeAgendamento();

            });
            async function inicializarPaginaDeAgendamento() {
                // Define a data de hoje no calendário
                const dateEl = document.getElementById('date');
                if (dateEl) {
                    const today = new Date().toISOString().slice(0, 10);
                    dateEl.value = today;
                }

                // Carrega os dados do usuário e, EM SEGUIDA, os horários de hoje
                await carregarDadosDoUsuarioEHorarios(); // Esta chamada agora funcionará
            }

            /**
             * ESTA É A FUNÇÃO QUE PRECISA SER RENOMEADA.
             * Ela carrega o usuário e DEPOIS chama a função para carregar os horários.
             */
            async function carregarDadosDoUsuarioEHorarios() { // <-- NOME CORRETO
                try {
                    const response = await fetch('/api/usuario-logado');
                    if (!response.ok) {
                        window.location.href = '/login.html';
                        return;
                    }
                    loggedInUser = await response.json();

                    const userNameElement = document.getElementById('user-name-text');
                    userNameElement.innerHTML = loggedInUser.nome;

                    const userType = loggedInUser.tipo_usuario ? loggedInUser.tipo_usuario.trim().toLowerCase() : '';
                    switch (userType) {
                        case 'admin':
                            document.querySelector('.admin-menu').style.display = 'block';
                            document.querySelector('#sidemenu > li.submenu.produto').style.display = 'block';
                            break;
                        case 'tecnico':
                            document.querySelector('.tecnico').style.display = 'block';
                            document.querySelector('#sidemenu > li.submenu.produto').style.display = 'block';
                            break;
                        case 'professor':
                            document.querySelector('.professor').style.display = 'block';
                            document.querySelector('.Horarios').style.display = 'block';

                            break;
                    }

                    await loadAvailability();

                } catch (error) {
                    console.error('Erro ao carregar dados do usuário:', error);
                }
            }
            function ativarFuncionalidadeMenu() {
                const sideMenu = document.getElementById("sidemenu");
                const openMenuBtn = document.querySelector(".fa-bars");
                const closeMenuBtn = document.querySelector(".fa-circle-xmark");

                if (openMenuBtn) openMenuBtn.addEventListener('click', () => sideMenu.style.left = "0px");
                if (closeMenuBtn) closeMenuBtn.addEventListener('click', () => sideMenu.style.left = "-800px");

                document.querySelectorAll('.submenu > a').forEach(menu => {
                    menu.addEventListener('click', function (e) {
                        e.preventDefault();
                        this.nextElementSibling.classList.toggle('open');
                        this.querySelector('.fas.fa-chevron-down').classList.toggle('rotate');
                    });
                });
            }

            // --- LÓGICA DE AGENDAMENTO ---

            let loggedInUser = null;
            const slotsEl = document.getElementById('slots');
            const dateEl = document.getElementById('date');
            const labEl = document.getElementById('lab');
            const submitBtn = document.getElementById('submitBtn');
            const msgEl = document.getElementById('msg');

            const morningStart = 7, morningEndExclusive = 11;
            const afternoonStart = 13, afternoonEndExclusive = 22;

            let occupiedSlots = [];
            let selectedSlot = null;

            /**
             * Busca os dados do utilizador e, se bem-sucedido, carrega a disponibilidade dos horários.
             */
            async function loadLoggedInUser() {
                fetch('/api/usuario-logado')
                    .then(response => {
                        // É uma boa prática verificar se a resposta da rede foi bem-sucedida
                        if (!response.ok) {
                            throw new Error('Falha ao buscar usuário. Status: ' + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        const userNameElement = document.getElementById('user-name-text');
                        userNameElement.innerHTML = data.nome;

                        // Correção 1: Normaliza o tipo de usuário usando a variável 'data'
                        const userType = data.tipo_usuario ? data.tipo_usuario.trim().toLowerCase() : '';

                        // Correção 2: Usa uma estrutura 'switch' para um código mais limpo e organizado
                        switch (userType) {
                            case 'admin':
                                document.querySelector('.admin-menu').style.display = 'block';
                                document.querySelector('#sidemenu > li.submenu.produto').style.display = 'block';
                                break;

                            case 'tecnico':
                                // Mostra AMBOS os menus para o técnico dentro de um único bloco
                                document.querySelector('.tecnico').style.display = 'block';
                                document.querySelector('#sidemenu > li.submenu.produto').style.display = 'block';
                                break;

                            case 'professor':
                                document.querySelector('.professor').style.display = 'block';
                                break;
                        }
                    })
                    .catch(error => console.error('Erro ao carregar usuário logado:', error));
            }

            /**
             * Valida a data e carrega os horários disponíveis da API.
             */
            async function loadAvailability() {
                const dataSelecionadaStr = dateEl.value;
                const labId = labEl.value;

                msgEl.style.display = 'none';
                msgEl.className = 'mensagem-status';
                slotsEl.innerHTML = '';

                const hojeStr = new Date().toISOString().slice(0, 10);

                if (dataSelecionadaStr < hojeStr) {
                    submitBtn.disabled = true;
                    msgEl.textContent = 'Não é possível agendar em datas passadas.';
                    msgEl.classList.add('erro');
                    msgEl.style.display = 'block';
                    return;
                }

                selectedSlot = null;
                submitBtn.disabled = true;

                try {
                    occupiedSlots = await fetchOccupiedSlotsFromAPI(dataSelecionadaStr, labId);
                    renderSlots();
                } catch (error) {
                    console.error('Erro ao carregar disponibilidade:', error);
                    msgEl.textContent = 'Erro ao carregar horários. Tente novamente.';
                    msgEl.classList.add('erro');
                    msgEl.style.display = 'block';
                }
            }

            function renderSlots() {
                const all = generateAllSlots();
                slotsEl.innerHTML = '';
                all.forEach(hour => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'bloco-horario';
                    btn.textContent = `${hour} — ${formatEnd(hour)}`;
                    btn.dataset.hour = hour;
                    if (occupiedSlots.includes(hour)) {
                        btn.classList.add('occupied');
                        btn.setAttribute('aria-disabled', 'true');
                    } else {
                        btn.addEventListener('click', () => {
                            selectedSlot = (selectedSlot === hour) ? null : hour;
                            updateSelectionUI();
                        });
                    }
                    slotsEl.appendChild(btn);
                });
                updateSelectionUI();
            }

            function updateSelectionUI() {
                document.querySelectorAll('.bloco-horario').forEach(el => {
                    el.classList.remove('selected');
                    if (!el.classList.contains('occupied') && el.dataset.hour === selectedSlot) {
                        el.classList.add('selected');
                    }
                });
                submitBtn.disabled = !selectedSlot;
            }

            async function fetchOccupiedSlotsFromAPI(date, labId) {
                const res = await fetch(`/api/availability?date=${encodeURIComponent(date)}&labId=${encodeURIComponent(labId)}`);
                if (!res.ok) throw new Error('Falha ao consultar disponibilidade');
                return (await res.json()).occupied || [];
            }

            function generateAllSlots() {
                const arr = [];
                for (let h = morningStart; h < morningEndExclusive; h++) arr.push(formatHour(h));
                for (let h = afternoonStart; h < afternoonEndExclusive; h++) arr.push(formatHour(h));
                return arr;
            }

            function formatHour(h) { return (h < 10 ? '0' + h : '' + h) + ':00'; }

            function formatEnd(start) {
                const [hh] = start.split(':');
                const endH = parseInt(hh) + 1;
                return (endH < 10 ? '0' + endH : '' + endH) + ':00';
            }

            // --- EVENT LISTENERS ---
            dateEl.addEventListener('change', loadAvailability);
            labEl.addEventListener('change', loadAvailability);

            submitBtn.addEventListener('click', async () => {
                if (!selectedSlot || !loggedInUser) return;
                const payload = {
                    labId: labEl.value,
                    date: dateEl.value,
                    hour: selectedSlot,
                    precisa_tecnico: document.querySelector('input[name="precisaTecnico"]:checked').value === 'true'
                };
                try {
                    const res = await fetch('/api/schedule', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await res.json();
                    if (!res.ok) throw new Error(result.error || 'Ocorreu um erro');

                    msgEl.textContent = result.message;
                    msgEl.className = 'mensagem-status sucesso';
                    msgEl.style.display = 'block';
                    await loadAvailability();
                } catch (err) {
                    msgEl.textContent = 'Erro ao enviar: ' + err.message;
                    msgEl.className = 'mensagem-status erro';
                    msgEl.style.display = 'block';
                }
            });
        </script>
</body>

</html>